# QEMU MCP Tool Introduction and User Guide
# QEMU Virtual Machine Management and Control Program (MCP) Specification Document

## 1. Service Introduction
This service is a Virtual Machine (VM) Management and Control Program (MCP) implemented based on the encapsulation of the `QEMU` (Quick Emulator) tool. Its core functions include **full-lifecycle management (creation/startup/shutdown/deletion/configuration modification), list query, and real-time status monitoring** of VMs on local or remote servers. It supports filtering by VM name, status, architecture, etc., providing standardized tool support for virtualized environment deployment, test scenario operation and maintenance, and enterprise-level VM management. It is compatible with multi-architecture virtualization requirements such as x86_64 and arm64.

## 2. Core Tool Information

| Tool Name               | Tool Function                                                                 | Core Input Parameters                                                                                                                                                                                                 | Key Return Content                                                                                                                                                                                                 |
|-------------------------|-------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `manage_vm`             | Full-lifecycle management of VMs on local/remote hosts (create/start/stop/delete/modify configuration)                                                                 | - `name`: VM name (required, unique identifier for the VM)<br>- `action`: Operation type (create/start/stop/delete/modify, required)<br>- `arch`: CPU architecture (required for create, e.g., x86_64/arm64)<br>- `memory`: Memory size (optional for create/modify, e.g., 2G/4096M, default: 2G)<br>- `disk`: Disk configuration (optional for create/modify, format "path=/data/vm/disk.qcow2,size=20G")<br>- `iso`: System image path (optional for create, e.g., /data/iso/ubuntu-22.04.iso)<br>- `vcpus`: Number of CPU cores (optional for create/modify, default: 2 cores)<br>- `vm_dir`: VM storage directory (optional for create, default: /var/lib/qemu)<br>- `host`: Remote host name/IP (default: localhost, not required for local operations)<br>- `ssh_port`: SSH port (default: 22, used for remote operations)<br>- `ssh_user`: SSH username (required for remote operations)<br>- `ssh_pwd`: SSH password (required for remote operations, alternative to ssh_key)<br>- `ssh_key`: SSH private key path (optional for remote operations, takes precedence over password) | - `success`: Whether the operation is successful (boolean)<br>- `message`: Operation result description (e.g., "VM ubuntu-vm created successfully")<br>- `data`: Dictionary containing VM operation information<br>  - `host`: Host name/IP of the operation<br>  - `vm_name`: VM name<br>  - `action`: Type of operation performed<br>  - `details`: Operation details (e.g., configuration comparison before and after modification, disk path) |
| `list_vms`              | VM list query on local/remote hosts (supports filtering by status, architecture, name)                                                                 | - `status`: VM status (optional, running/stopped/all, default: all)<br>- `arch`: CPU architecture (optional, e.g., x86_64/arm64, filters VMs of the specified architecture)<br>- `filter_name`: Fuzzy name filtering (optional, e.g., "ubuntu" filters VMs containing this field)<br>- `vm_dir`: VM storage directory (default: /var/lib/qemu)<br>- `host`/`ssh_port`/`ssh_user`/`ssh_pwd`/`ssh_key`: Same as `manage_vm` | - `success`: Whether the operation is successful (boolean)<br>- `message`: Operation result description (e.g., "Successfully obtained 3 running VMs locally")<br>- `data`: Dictionary containing VM list<br>  - `host`: Host name/IP of the operation<br>  - `vm_count`: Total number of VMs<br>  - `vms`: VM list, each VM includes:<br>    - `name`: VM name<br>    - `arch`: CPU architecture<br>    - `vcpus`: Number of CPU cores<br>    - `memory`: Memory size<br>    - `disk`: Disk configuration (path + size)<br>    - `status`: Running status (running/stopped) |
| `monitor_vm_status`     | Real-time status monitoring of VMs on local/remote hosts (CPU/memory/disk/network)                                                                 | - `name`: VM name (required, specifies the monitoring target)<br>- `metrics`: Monitoring metrics (optional, cpu/memory/disk/network/all, default: all)<br>- `interval`: Monitoring sampling interval (optional, unit: seconds, default: 5 seconds, minimum: 1 second)<br>- `count`: Number of sampling times (optional, default: 1 time, 0 means continuous sampling until manual stop)<br>- `host`/`ssh_port`/`ssh_user`/`ssh_pwd`/`ssh_key`: Same as `manage_vm` | - `success`: Whether the operation is successful (boolean)<br>- `message`: Operation result description (e.g., "Successfully obtained 5 sampling data points for ubuntu-vm")<br>- `data`: Dictionary containing monitoring data<br>  - `host`: Host name/IP of the operation<br>  - `vm_name`: VM name<br>  - `timestamp`: List of sampling timestamps (corresponding to each data point's timestamp)<br>  - `metrics_data`: Monitoring metric data (returns sampling values of corresponding metrics according to the `metrics` field) |

## 3. Tool User Guide

1. **Local Operation Rules**: Do not fill in the `host`, `ssh_user`, `ssh_pwd`, and `ssh_key` parameters; operations will be performed on the local machine's (`localhost`) VMs by default. Only core business parameters such as `name` and `action` need to be provided (e.g., `arch` must be supplemented for `create`, and configuration items to be modified must be supplemented for `modify`).

2. **Remote Operation Rules**: Must provide `host` (remote host IP/hostname), `ssh_user` (SSH username), and either `ssh_pwd` or `ssh_key` (one of the two); `ssh_port` is optional (default: 22). Ensure the remote host has the QEMU toolset installed (including qemu-system-x86_64/qemu-img, etc.), and the SSH user has read/write permissions for VM files (disks/images) and QEMU operation permissions.

3. **Permission Requirements**:  

    - Local operations: Must run under a user with QEMU operation permissions (ordinary users can operate personal VMs; `sudo` is required for system-level VMs).  

    - Remote operations: The SSH user must have read/write permissions for the QEMU tool and VM storage directory (`vm_dir`). It is recommended to grant KVM acceleration permissions via `usermod -aG kvm username`.

## 4. Notes

- **Uniqueness of VM Names**: The `name` parameter cannot be duplicated on the same host. Duplicate creation will return a "VM already exists" error, and you need to perform the `delete` operation first or use a different name.

- **Architecture and Image Matching**: The `arch` parameter must match the architecture of the `iso` system image during `create` (e.g., arm64 architecture requires a corresponding arm version ISO), otherwise the VM cannot start.

- **Disk Format Restrictions**: The tool supports qcow2 (dynamic expansion) and raw (fixed size) formats by default. Disk expansion via `modify` operation only supports the qcow2 format; the raw format requires manual expansion before updating the configuration.

- **Monitoring Prerequisites**: `monitor_vm_status` only supports monitoring running VMs; metrics cannot be collected for non-running VMs. Ensure the target host has monitoring dependency tools such as `iostat` and `iftop` installed.

- **Reset and Data Risks**: `manage_vm(action=delete)` will delete VM disk files; confirm data has been backed up before operation. `modify` operations (e.g., adjusting memory/CPU) will restart the VM; stop business tasks on the VM in advance.

- **Tool Dependencies**: All operations depend on the target host having the QEMU toolset installed (version 6.0+). If not installed, an error "qemu-system-xxx: command not found" will be returned, and QEMU components corresponding to the architecture need to be installed through official channels.